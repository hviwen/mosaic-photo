## 导入智能裁剪比例修复与全覆盖布局兼容方案

### 摘要
1. 修复当前“无条件夹紧到 `4:6 ~ 6:4`”的问题，改为按你定义的规则执行。  
2. 严格保证方向不反转：竖图不裁成横图，横图不裁成竖图。  
3. 在保持“无缝隙、全覆盖”前提下，把非极端图的裁剪降到最小（优先保持原比例，冲突时最小裁剪兜底）。  
4. 作用范围按你确认：覆盖全部智能裁剪入口与全部重排触发路径。  

### 实施方案（决策完成）

### 1. 统一比例策略内核（`/Users/pan/hankins/native/mosaic-photo/src/utils/smartCrop.ts`）
1. 重写 `clampSmartCropTargetAspect(targetAspect, imageWidth, imageHeight)` 的规则：  
- 先算原图比例 `srcAspect = imageWidth / imageHeight`。  
- 竖图且 `srcAspect < 4/6`：返回 `clamp(targetAspect, 4/6, 1)`。  
- 横图且 `srcAspect > 6/4`：返回 `clamp(targetAspect, 1, 6/4)`。  
- 其他情况：返回 `srcAspect`（保持原图比例）。  
2. 边界按“严格不等于”执行：`< 4/6` 与 `> 6/4` 才触发收敛，等于边界不触发。  
3. `calculateSmartCrop` 继续只做“位置优化+包含主体”，比例由上面统一策略决定。  

### 2. 调用链一致化（消除主线程/Worker分叉）
1. 在 `/Users/pan/hankins/native/mosaic-photo/src/workers/layoutWorker.ts` 去掉 `ta` 必须在 `[4:6, 6:4]` 才允许智能裁剪的额外限制，避免 Worker 路径绕开新策略。  
2. 在 `/Users/pan/hankins/native/mosaic-photo/src/stores/mosaic.ts` 的检测回填与替换照片路径，移除同类范围门槛，统一走新比例策略。  
3. 保持 `shouldApplySmartCropByImageAspect` 作为“是否启用检测引导”的开关，但比例决策完全交给新内核，避免重复规则。  

### 3. 铺满布局重构：方向优先 + 最小裁剪（`/Users/pan/hankins/native/mosaic-photo/src/composables/useLayout.ts` 与 `/Users/pan/hankins/native/mosaic-photo/src/workers/layoutWorker.ts`）
1. 新增共享分配模块 `/Users/pan/hankins/native/mosaic-photo/src/utils/fillArrangeAssignment.ts`，主线程与 Worker 共用，避免两套策略漂移。  
2. 对每张图建立布局策略字段：`sourceAspect`、`preferredAspect`、`orientation`、`isExtreme`。  
3. 采用全局最小代价分配（替换当前局部贪心）：  
- 代价主项：`abs(log(tileAspect) - log(preferredAspect))`（即最小裁剪损失）。  
- 非极端图加更高权重（优先保持原比例）。  
- 方向反转加大惩罚（强约束竖/横不反转）。  
4. 分区与切分保持“画布全覆盖、无重叠”不变，先保证几何铺满，再用全局分配把裁剪损失压到最低。  

### 4. 兼容与稳定性
1. 不改项目文件格式与持久化结构（`ProjectV1` 无迁移成本）。  
2. 不改 `PhotoEntity`/`Placement` 对外字段（无调用方接口迁移）。  
3. 保持 `autoLayout`、`autoLayoutAsync`、导入后自动排版、替换后重排同一套行为。  

### 公共 API / 接口 / 类型变更
1. 对外持久化与业务类型：无破坏性变更。  
2. 内部新增工具模块：`/Users/pan/hankins/native/mosaic-photo/src/utils/fillArrangeAssignment.ts`。  
3. `smartCrop` 内部比例函数语义变化（行为修复，不改函数签名）。  

### 测试与验收用例
1. 修改 `/Users/pan/hankins/native/mosaic-photo/test/smartCrop.calculate.test.ts`：  
- 竖图极端：目标比再宽也不会超过 `1`，且向 `4:6` 收敛。  
- 横图极端：目标比再窄也不会低于 `1`，且向 `6:4` 收敛。  
- 非极端竖/横/方图：输出比例等于原图比例。  
- 边界值：`4:6`、`6:4` 不触发额外收敛。  
2. 新增 `/Users/pan/hankins/native/mosaic-photo/test/fillArrange.aspect-policy.test.ts`：  
- 混合竖横图下，方向不反转。  
- 仍满足无重叠、无缝隙、全覆盖（保留原覆盖断言）。  
- 非极端图裁剪损失低于旧贪心算法基线（同 seed）。  
3. 回归运行：`pnpm vitest --run` 全绿。  

### 影响范围与回滚
1. 影响范围：`smartCrop`、`useLayout`、`layoutWorker`、`mosaic store`、布局相关测试。  
2. 回滚计划：  
- 第一步回滚共享分配模块接入（恢复原贪心分配）。  
- 第二步回滚 `smartCrop` 比例内核到旧逻辑。  
- 第三步回滚调用链门槛调整。  
3. 风险控制：先保证测试覆盖“方向不反转 + 全覆盖 + 最小裁剪”三组核心不变量，再合并。  

### 明确假设与默认值
1. 规则适用：全部智能裁剪入口。  
2. 触发范围：全部重排触发（含替换后重排）。  
3. 优先级：全覆盖与方向不反转为硬约束；非极端图“保持原比例”为软约束，冲突时走最小裁剪。  
4. 数值边界：`4:6 = 0.666...`，`6:4 = 1.5`，比较按严格不等式触发。  
