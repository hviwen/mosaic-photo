# Plan: 马赛克布局四个 P0 Bug 修复
四个 Bug 有两个根因：

- **Bug #1/#2/#3**：`onSmartDetectionsChanged` 回调异步更新了 `layoutCrop` 但没有同步更新 `scale`，导致渲染矩形 `(crop.width × scale)` 不再等于 tile 宽度，引发重叠、缝隙和画布未填满。
- **Bug #4**：非极端比例图片（aspect 在 [0.667, 1.5] 之间）完全不受裁剪比例保护，`centerCropToAspect()` 直接按 tile 比例裁剪，可导致正方形图被裁成 1.9 的横幅。

---

## Steps

### Step 1 — 修复 Bug #1/#2/#3：同步更新 scale

在 `mosaic.ts:180-201` 的 `onSmartDetectionsChanged` 回调中：

1. 在更新 `layoutCrop` 之前，先计算出当前 tile 的实际宽高：
    ```
    tileW = photo.layoutCrop.width * photo.scale
    tileH = photo.layoutCrop.height * photo.scale
    ```

2. 更新 `photo.layoutCrop = clampCrop(next, ...)` 之后，立即重算 `photo.scale`：
    ```
    photo.scale = tileW / photo.layoutCrop.width
    ```

这样保证 `photo.layoutCrop.width * photo.scale === tileW`，渲染矩形始终等于 tile。

### Step 2 — 修复 Bug #4：为所有图片添加裁剪比例保护

问题：`useLayout.ts:600-615` 和 `mosaic.ts:185-199` 中，非极端图不经过 `calculateSmartCrop`，直接按 tile 比例做居中裁剪。

#### 2a — 添加最大裁剪损失限制

在 `image.ts:262-296` 的 `centerCropToAspect` 中：
- 计算裁剪后的面积损失比：`areaLoss = 1 - (newW * newH) / (crop.width * crop.height)`
- 若 `areaLoss > MAX_CROP_AREA_LOSS`（建议 0.30），将 `targetAspect` 向 `currentAspect` 方向收敛，直到损失不超过阈值

#### 2b — 允许画布微调

在 `useLayout.ts:410` 的 `fillArrangePhotos` 中：
- 当最优候选的 `weightedLoss` 超过阈值时，尝试在 `[W−100, W+100] × [H−100, H+100]` 范围内搜索几组画布尺寸
- 每向 25px 步进，共约 81 种组合中采样 9~16 种代表性尺寸
- 选择使全局 `weightedLoss` 最低的画布尺寸
- 将最终使用的画布尺寸写回 store（使用 `canvasOffsetX`/`canvasOffsetY` 字段）

### Step 3 — 让非极端图也享受智能裁剪保护

修改判断条件：

在 `useLayout.ts:600-605` 和 `mosaic.ts:185-190` 中：
- 始终传入 `detections`（如果有的话），让 `calculateSmartCrop` 内部决策

在 `smartCrop.ts:286-305` 的 `clampSmartCropTargetAspect` 中：
- 改为：将目标 clamp 到 `[srcAspect × (1 − maxDeviation), srcAspect × (1 + maxDeviation)]`，其中 `maxDeviation ≈ 0.25`

### Step 4 — Worker 端同步修复

`layoutWorker.ts` 中的 `fillArrangePhotosWorker` 需同步 Step 2b 的画布微调逻辑。

### Step 5 — 更新验证逻辑

在 `fillArrangeValidation.ts` 的 `validateFillArrangePlacements` 中，确认验证不会因 ±100px 调整而误报。

### Step 6 — 更新测试

- **fillArrange.layout.test.ts**：验证异步裁剪更新后 scale 被正确重算；验证画布微调后 placements 仍通过验证
- **smartCrop.calculate.test.ts**：验证正方形图裁剪损失不超过 30%；验证比例图结果 aspect 被限制在合理范围
- **fillArrange.aspect-policy.test.ts**：验证非极端图的裁剪比例偏差不超过阈值

---

## Verification

1. 运行 `pnpm vitest run` 确保所有现有测试通过
2. 用附录中的 4 张问题图片进行回归测试
3. 在画布上摆放 10-20 张混合比例图片，目视确认无重叠/缝隙
4. 在 DevTools console 中确认无 `[LayoutDebug] validation failed` 警告

---

## Decisions

- **裁剪限制策略**：双重限制（面积损失 ≤ 30% + 比例偏差 ≤ 25%），覆盖更多边角情况
- **画布微调**：在 ±100px 范围内采样，平衡效果与性能
- **非极端图智能裁剪**：始终传入 `detections`（如果已有），由 `calculateSmartCrop` 内部决策
