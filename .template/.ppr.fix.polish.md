# 马赛克照片编辑器 - 问题修复 & 优化调整任务

## 一、优化调整

### 优化 1：导入时智能裁剪比例限制（P0 优先级）

**目标：** 强制限制自动裁剪的最大宽高比，避免过度裁剪导致内容显示不全。

**具体要求：**
1. 修改 `src/utils/smartCrop.ts` 中的 `calculateSmartCrop()` 函数
2. 添加严格的比例限制逻辑：
   - **竖图**（`imageHeight > imageWidth`）：裁剪后的宽高比不得超过 **1.5**（即 6:4）
   - **横图**（`imageWidth > imageHeight`）：裁剪后的宽高比不得低于 **0.667**（即 4:6）
3. 实现方式：
   - 在计算 `targetAspect` 后，使用 `clamp(targetAspect, 0.667, 1.5)` 进行限制
   - 确保所有裁剪结果都在此范围内，无例外
4. 如果检测到人脸，在满足比例限制的前提下，确保人脸区域可见尺寸不小于 100×100 像素

**涉及文件：**
- `src/utils/smartCrop.ts` - `calculateSmartCrop()` 函数（约 723-830 行）

---

### 优化 2：选中单张图片时自动展开裁剪面板

**目标：** 提升用户体验，减少操作步骤。

**具体要求：**
1. 修改 `src/components/SidebarRight.vue` 或 `src/components/PhotoEditor.vue` 中的裁剪面板组件
2. 当用户选中单张照片时（`selectedPhotos.length === 1`），自动展开"裁剪"面板
3. 实现方式：
   - 找到裁剪面板的折叠/展开状态控制变量（可能是 `v-expansion-panel` 的 `modelValue`）
   - 在 `watch` 或 `computed` 中监听选中照片数量变化
   - 当选中单张照片时，设置裁剪面板为展开状态

**涉及文件：**
- `src/components/SidebarRight.vue` 或 `src/components/PhotoEditor.vue`

---

## 二、问题修复

### 问题 1：单张照片裁剪模式交互问题（P0 优先级）

#### 1.1 缩小/放大按钮布局遮挡

**当前问题：** 裁剪编辑区域的"缩小"和"放大"按钮横向排布时会相互遮挡。

**期望行为：** 将按钮改为竖向排布（垂直布局）。

**实现步骤：**
1. 定位 `src/components/PhotoEditor.vue` 或 `src/components/CanvasStage.vue` 中的缩放按钮容器
2. 将按钮容器的 `flex-direction` 从 `row` 改为 `column`
3. 调整按钮间距和对齐方式，确保视觉清晰

---

#### 1.2 鼠标滚轮缩放功能异常

**当前问题：** 按住 Shift 键 + 鼠标滚轮只能放大图片，无法缩小。

**期望行为：** 滚轮向上滚动放大，向下滚动缩小。

**实现步骤：**
1. 定位 `src/components/CanvasStage.vue` 中的 `wheel` 事件处理函数
2. 检查缩放逻辑中是否存在单向限制（例如 `delta > 0` 的条件判断）
3. 修改为双向缩放：
   - `delta > 0` → 放大（`scale *= 1.1`）
   - `delta < 0` → 缩小（`scale /= 1.1`）
4. 确保缩放范围在合理区间内（例如 `0.1 ~ 5`）

---

#### 1.3 隐藏画布中的 8 个控制点

**当前问题：** 选中照片后出现的 8 个控制点（用于调整尺寸/旋转）在裁剪模式下无意义。

**期望行为：** 在裁剪模式下隐藏这些控制点。

**实现步骤：**
1. 定位 `src/components/CanvasStage.vue` 中绘制控制点的逻辑（可能在 `drawPhoto()` 或 `drawSelection()` 函数中）
2. 添加条件判断：
   ```typescript
   if (mosaicStore.cropMode) {
     // 裁剪模式下不绘制控制点
     return;
   }
   ```
3. 确保裁剪模式下只显示裁剪框，不显示变换控制点

---

#### 1.4 添加"允许移动照片"开关

**当前问题：** 选中照片后默认可以拖动移动，可能导致误操作。

**期望行为：** 
- 默认情况下，选中照片后不可移动
- 在右侧操作区添加一个开关控件"允许移动照片"（默认关闭）
- 只有开关打开时，用户才能拖动照片

**实现步骤：**
1. 在 `src/stores/mosaic.ts` 中添加状态变量：
   ```typescript
   const allowPhotoMove = ref(false);
   ```
2. 在 `src/components/SidebarRight.vue` 中添加开关控件：
   ```vue
   <v-switch
     v-model="mosaicStore.allowPhotoMove"
     label="允许移动照片"
     density="compact"
   />
   ```
3. 在 `src/components/CanvasStage.vue` 的拖动事件处理函数中添加判断：
   ```typescript
   if (!mosaicStore.allowPhotoMove) {
     return; // 不允许移动时直接返回
   }
   ```

---

### 问题 2：人脸检测功能失效（P1 优先级）

**当前问题：** 
- 人脸检测完全失效，所有相关功能无作用
- 右侧"原图缩略"模块始终显示"已检测到 0 个人脸区域"
- 未显示人脸检测红框

**期望行为：**
1. 当用户选中单张照片后：
   - 如果检测到人脸（`faceBoxes.length > 0`）：
     - 在"原图缩略"模块的缩略图上叠加显示红色矩形框（`stroke: '#ff0000'`, `lineWidth: 2`）
     - 显示文本："已检测到 n 个人脸区域"
   - 如果未检测到人脸（`faceBoxes.length === 0`）：
     - 显示文本："未检测到人脸区域"
     - 显示提示："请确保原图中包含人脸，或调整裁剪区域重新检测"

**排查步骤：**
1. 检查浏览器是否支持 `FaceDetector` API：
   - 在控制台运行 `'FaceDetector' in window`
   - 如果返回 `false`，说明浏览器不支持（需要使用 Chrome/Edge 且启用实验性功能）
2. 检查 `src/utils/smartCrop.ts` 中的人脸检测日志：
   - 搜索 `[FaceDebug]` 日志输出
   - 确认 `detectFaces()` 是否被调用，返回结果是否为空
3. 检查 `src/components/SidebarRight.vue` 中的 `faceBoxes` 计算属性：
   - 确认 `getSmartDetections(photoId)` 是否返回正确数据
   - 确认 `kind === 'face'` 的过滤逻辑是否正确

**修复步骤：**
1. 如果浏览器不支持 `FaceDetector` API：
   - 在文档中添加说明，要求使用支持的浏览器
   - 或考虑集成第三方人脸检测库（如 MediaPipe、face-api.js）
2. 如果检测逻辑有问题：
   - 修复 `src/utils/smartCrop.ts` 中的 `detectFaces()` 函数
   - 确保检测结果正确存入 `detectionCache`
3. 如果 UI 显示有问题：
   - 修复 `src/components/SidebarRight.vue` 中的 `faceBoxes` 计算逻辑
   - 确保 SVG `<rect>` 元素正确绘制红框

**涉及文件：**
- `src/utils/smartCrop.ts` - 人脸检测核心逻辑
- `src/components/SidebarRight.vue` - 原图缩略模块 UI（约 99-108 行和 392-405 行）
- `src/stores/mosaic.ts` - 照片导入时的检测触发逻辑

---

## 三、验证清单

完成上述修改后，请验证以下场景：

1. ✅ 导入竖图（如 3:4 比例），确认裁剪后不超过 6:4
2. ✅ 导入横图（如 16:9 比例），确认裁剪后不超过 4:6
3. ✅ 选中单张照片，确认"裁剪"面板自动展开
4. ✅ 进入裁剪模式，确认缩小/放大按钮竖向排布且不遮挡
5. ✅ 按住 Shift + 滚轮，确认可以双向缩放
6. ✅ 裁剪模式下，确认 8 个控制点已隐藏
7. ✅ 默认状态下，确认照片不可拖动移动
8. ✅ 打开"允许移动照片"开关，确认照片可拖动
9. ✅ 选中包含人脸的照片，确认显示红色检测框和正确的人脸数量
10. ✅ 选中不包含人脸的照片，确认显示"未检测到人脸区域"提示