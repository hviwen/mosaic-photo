## ğŸ¤– æ™ºèƒ½è£å‰ª - è¯¦ç»†å®ç°æ–¹æ¡ˆ

### ç›®æ ‡
- åœ¨**ä¸ç‰ºç‰²äº¤äº’æµç•…**çš„å‰æä¸‹ï¼Œè®©è‡ªåŠ¨è£å‰ªæ›´â€œåƒäººâ€ï¼šä¼˜å…ˆä¿ç•™äººè„¸/ä¸»ä½“ï¼Œå…¶æ¬¡ä¿ç•™ç”»é¢ç»†èŠ‚å¯†åº¦æ›´é«˜çš„åŒºåŸŸ
- **å¯å›é€€**ï¼šæ£€æµ‹å¤±è´¥/è¶…æ—¶/æµè§ˆå™¨ä¸æ”¯æŒæ—¶ï¼Œè‡ªåŠ¨é€€å›åŸæœ‰â€œå±…ä¸­è£å‰ªâ€é€»è¾‘
- **å¯æ’æ‹”**ï¼šæ£€æµ‹èƒ½åŠ›ä¸è£å‰ªé€»è¾‘è§£è€¦ï¼Œå…è®¸åç»­æŒ‰éœ€æ¥å…¥ MediaPipe / face-api.js ç­‰åº“

### ğŸ“‹ å®ç°æ€è·¯
```
åŠ è½½å›¾ç‰‡ â†’ (å¯é€‰) äººè„¸æ£€æµ‹ â†’ (å¿«é€Ÿå…œåº•) æ˜¾è‘—æ€§æ¡† â†’ è®¡ç®—ç„¦ç‚¹ä¸­å¿ƒç‚¹ â†’ è‡ªåŠ¨è£å‰ª
```

### âœ… ç°çŠ¶ï¼ˆå·²è½åœ°ï¼‰
å½“å‰ä»“åº“å·²åœ¨ `src/utils/smartCrop.ts` ä¸­å®ç°ä¸€å¥—è½»é‡æ™ºèƒ½è£å‰ªç®¡çº¿ï¼š
- **äººè„¸æ£€æµ‹**ï¼šä¼˜å…ˆä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ `FaceDetector`ï¼ˆShape Detection APIï¼‰
- **å¯¹è±¡/ä¸»ä½“å…œåº•**ï¼šè‡ªç ”â€œæ˜¾è‘—æ€§ï¼ˆè¾¹ç¼˜/ç»†èŠ‚å¯†åº¦ï¼‰â€æ¡†ï¼Œé¿å…å®Œå…¨å±…ä¸­å¯¼è‡´ä¸»ä½“åç§»
- **è£å‰ªè®¡ç®—**ï¼šå°†æ£€æµ‹æ¡†èåˆæˆâ€œç„¦ç‚¹ bboxâ€ï¼Œå†ä»¥å…¶**ä¸­å¿ƒç‚¹**é©±åŠ¨å¯¹é½ä¸å›é€€

### ğŸ”§ æŠ€æœ¯é€‰å‹ï¼ˆå»ºè®®ï¼‰
#### æ–¹æ¡ˆ 0ï¼ˆé»˜è®¤/æœ€è½»é‡ï¼‰ï¼šåŸç”Ÿ FaceDetector + æ˜¾è‘—æ€§å…œåº•
- ä¼˜ç‚¹ï¼šé›¶æ¨¡å‹æ–‡ä»¶ã€åŠ è½½å¿«
- ç¼ºç‚¹ï¼šå…¼å®¹æ€§æœ‰é™ï¼ˆéƒ¨åˆ†æµè§ˆå™¨ä¸æ”¯æŒ Shape Detection APIï¼‰

#### æ–¹æ¡ˆ Aï¼ˆæ¨èå…œåº•ï¼‰ï¼šMediaPipe Tasks Visionï¼ˆFaceDetectorï¼‰
- ä¼˜ç‚¹ï¼šè·¨æµè§ˆå™¨æ›´ç¨³ï¼Œç²¾åº¦è¾ƒé«˜
- ç¼ºç‚¹ï¼šéœ€è¦ wasm + æ¨¡å‹æ–‡ä»¶ï¼ˆè¦åšæ‡’åŠ è½½/ç¼“å­˜ï¼Œé¿å…é¦–å±å˜æ…¢ï¼‰

#### æ–¹æ¡ˆ Bï¼ˆå¤‡é€‰ï¼‰ï¼šface-api.js
- ä¼˜ç‚¹ï¼šç”Ÿæ€æˆç†Ÿã€å¯æ‹“å±•ï¼ˆå…³é”®ç‚¹/è¡¨æƒ…ç­‰ï¼‰
- ç¼ºç‚¹ï¼šé€šå¸¸ä¾èµ– tfjsï¼Œä½“ç§¯ä¸åˆå§‹åŒ–æˆæœ¬æ›´é«˜

å®‰è£…å‘½ä»¤ï¼ˆæŒ‰éœ€é€‰ç”¨ï¼Œä¸å¿…åŒæ—¶å¯ç”¨ï¼‰ï¼š
```bash
pnpm add @mediapipe/tasks-vision
pnpm add face-api.js
```

### ğŸ§  æ ¸å¿ƒæ•°æ®ç»“æ„
ç»Ÿä¸€ç”¨ `SmartDetection` è¡¨ç¤ºæ£€æµ‹ç»“æœï¼š
- `kind: 'face' | 'object'`
- `box: {x,y,width,height}`ï¼šé‡è¦åŒºåŸŸçš„ bboxï¼ˆåŸå›¾åæ ‡ç³»ï¼‰
- `score: 0~1`ï¼šç½®ä¿¡åº¦/æƒé‡ï¼ˆç”¨äºåˆå¹¶å¤šä¸ªæ£€æµ‹æ¡†ï¼‰

### ğŸ” æ•´ä½“æµç¨‹ï¼ˆå¯¹åº”ä»£ç ï¼‰
1. **å¯¼å…¥æ—¶é¢„çƒ­æ£€æµ‹**
   - `src/utils/image.ts` çš„ `createPhotoFromFile()` ä¼šè°ƒç”¨ `prefetchSmartDetections(photoId, canvas)`
   - å…ˆåŒæ­¥åšâ€œæ˜¾è‘—æ€§æ¡†â€ä»¥ä¾¿é¦–æ¬¡è‡ªåŠ¨æ’ç‰ˆç«‹åˆ»å¯ç”¨
   - å†å¼‚æ­¥åšäººè„¸æ£€æµ‹ï¼›å®Œæˆåä¼šé€’å¢ `revision` å¹¶é€šçŸ¥å¸ƒå±€é‡æ’

2. **æ£€æµ‹åŠ é€Ÿä¸åæ ‡æ˜ å°„**
   - `toCanvasForDetection()` ä¼šå°†å›¾ç‰‡ç­‰æ¯”ç¼©æ”¾åˆ° `detectionMaxEdge`ï¼ˆé»˜è®¤ 640ï¼‰
   - æ£€æµ‹è¾“å‡º bbox åŸºäºç¼©æ”¾ç”»å¸ƒï¼Œéœ€è¦ä¹˜ä»¥ `scaleX/scaleY` æ˜ å°„å›åŸå›¾

3. **äººè„¸æ£€æµ‹ï¼ˆå¯æ’æ‹” Providerï¼‰**
   - é»˜è®¤ï¼šåŸç”Ÿ `FaceDetector`
   - å¯é€‰ï¼šé€šè¿‡ `setFaceDetectionProvider()` æ³¨å…¥ç¬¬ä¸‰æ–¹å®ç°ï¼ˆMediaPipe/face-api.jsï¼‰
   - ç›®çš„ï¼šé¿å…æŠŠå¤§ wasm/æ¨¡å‹å¼ºç»‘è¿›ä¸»åŒ…ï¼ŒæŒ‰éœ€åŠ è½½

4. **æ˜¾è‘—æ€§ï¼ˆå¯¹è±¡ï¼‰å…œåº•**
   - `detectSaliencyObject()` é€šè¿‡æ¢¯åº¦èƒ½é‡ï¼ˆ|dx|+|dy|ï¼‰åœ¨ 16Ã—16 ç½‘æ ¼ä¸Šç»Ÿè®¡
   - å– Top 18% é«˜èƒ½æ ¼å­åˆæˆ bboxï¼Œè¿‡æ»¤â€œèƒ½é‡åˆ†å¸ƒè¿‡å‡åŒ€/å‡ ä¹è¦†ç›–å…¨å›¾â€çš„æƒ…å†µ

5. **è£å‰ªè®¡ç®—ï¼ˆä¸­å¿ƒç‚¹é©±åŠ¨ï¼‰**
   - `centerCropToAspect()`ï¼šè‹¥æœ‰ detections â†’ è°ƒç”¨ `calculateSmartCrop()`ï¼›å¦åˆ™åŸé€»è¾‘å±…ä¸­è£å‰ª
   - `calculateSmartCrop()`ï¼š
     1) åœ¨ `baseCrop` å†…æ‰¾ä¸€ä¸ªæ»¡è¶³ç›®æ ‡æ¯”ä¾‹çš„â€œæœ€å¤§å¯ç”¨è£å‰ªæ¡†â€
     2) åˆå¹¶æ£€æµ‹æ¡†å¾—åˆ° `focus`ï¼ˆæƒé‡ç»¼åˆ score + é¢ç§¯ï¼‰
     3) å¯¹ `focus` åŠ  paddingï¼ˆé¿å…åˆ‡è„¸/è´´è¾¹ï¼‰
     4) è®¡ç®— `focusCenter`ï¼ˆä¸­å¿ƒç‚¹ï¼‰ï¼Œå¹¶åœ¨å¯è¡Œæ—¶ç§»åŠ¨è£å‰ªæ¡†è®© `focusPadded` å®Œæ•´è½å…¥ï¼›ä¸å¯è¡Œæ—¶é€€åŒ–ä¸ºâ€œä»¥ä¸­å¿ƒç‚¹å¯¹é½â€

### ğŸ§© MediaPipe æ¥å…¥æ–¹å¼ï¼ˆæ¨èï¼šä½œä¸º Provider æ³¨å…¥ï¼‰
> ä¸‹é¢ç¤ºä¾‹æ˜¯â€œé›†æˆæ–¹å¼â€ï¼Œä¸ç›´æ¥å†™è¿› `smartCrop.ts`ï¼Œé¿å…å¼ºä¾èµ–ä¸é¦–å±è´Ÿæ‹…ã€‚

1) åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µï¼ˆä¾‹å¦‚ `src/main.ts` æˆ–å•ç‹¬çš„æ’ä»¶æ–‡ä»¶ï¼‰æ³¨å…¥ Providerï¼š
```ts
import { setFaceDetectionProvider } from '@/utils/smartCrop'

setFaceDetectionProvider(async (canvas, { maxFaces }) => {
  // ä¼ªä»£ç ï¼šç”¨ MediaPipe è¿”å› boundingBoxï¼ˆåŸºäº canvas åæ ‡ï¼‰
  // ä½ éœ€è¦åœ¨æ­¤å¤„åšï¼š
  // - æ‡’åŠ è½½ @mediapipe/tasks-vision
  // - åˆå§‹åŒ– FilesetResolver + FaceDetectorï¼ˆå»ºè®®å•ä¾‹ç¼“å­˜ï¼‰
  // - detector.detect(canvas) å¹¶æ˜ å°„ä¸º { boundingBox, score }
  return []
})
```

2) èµ„æºä¸æ€§èƒ½å»ºè®®
- wasm ä¸æ¨¡å‹æ–‡ä»¶å»ºè®®æ”¾åœ¨ `public/` ä¸‹å¹¶èµ° CDN/ç¼“å­˜ï¼ˆé¿å…æ¯æ¬¡åˆ·æ–°é‡æ–°æ‹‰å–ï¼‰
- åˆå§‹åŒ–å¯èƒ½è¾ƒæ…¢ï¼šå»ºè®®é…åˆ `deadlineMs`ï¼ˆé»˜è®¤ 450msï¼‰ä¸æ‡’åŠ è½½ï¼Œä¿è¯äº¤äº’ä¸å¡é¡¿

### ğŸ§© face-api.js æ¥å…¥æ–¹å¼ï¼ˆå¤‡é€‰ï¼šåŒæ ·ä½œä¸º Provider æ³¨å…¥ï¼‰
- åŒæ ·é€šè¿‡ `setFaceDetectionProvider()` æ³¨å…¥å³å¯
- å»ºè®®ä½¿ç”¨æ›´è½»çš„ detectorï¼ˆä¾‹å¦‚ TinyFaceDetectorï¼‰ï¼Œå¹¶åšå¥½æ¨¡å‹æ–‡ä»¶ç¼“å­˜ä¸æ‡’åŠ è½½

### å‚è€ƒæ–‡æ¡£
- [Face Detection API](https://justadudewhohacks.github.io/face-api.js/docs/index.html)
- [MediaPipe Face Detection](https://ai.google.dev/edge/mediapipe/solutions/vision/face_detector/web_js?hl=zh-cn)
