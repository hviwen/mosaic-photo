# 马赛克照片编辑器 — 五项修复与优化

## TL;DR
需求涉及 5 个变更项。经代码审查，P1-3（人脸红框）和 P0-2（导入限制/toast 提示）已基本实现，只需微量验证/补强。真正需要编码的核心工作集中在 P0-1（裁剪模式不重排 + z-index 调整）、优化 1（裁剪比例限制）和优化 2（中心放置策略）。

## 现状分析

| 编号 | 状态 | 说明 |
|------|------|------|
| P0-1 | ⚠️ 部分实现 | enterCropMode() 已重置 crop 为全图，绘制逻辑也已正确显示完整原图。但 applyCrop() 仍调用 autoLayout() 触发全局重排；z-index 未做裁剪模式特殊处理 |
| P0-2 | ✅ 已实现 | MAX_IMPORT_PHOTO_COUNT=150、截断逻辑、toast 提示、forceSplitLargestRect() 兜底均已就位。需做 150 张场景的集成验证 |
| P1-3 | ✅ 已实现 | SidebarRight.vue:99-108 已用 SVG <rect> 绘制红色人脸框，faceBoxes computed 正确过滤 kind==='face'，detectionTick 确保响应式更新 |
| 优化1 | ❌ 未实现 | calculateSmartCrop() 无比例限制逻辑 |
| 优化2 | ❌ 未实现 | 贪心匹配仅按宽高比差值选照片，无中心距离权重 |

---

## 实现步骤

### Step 1: P0-1 — 裁剪确认不触发全局重排

#### 1a. 新增 applyCropLocal() 函数（mosaic.ts:839-863）
- 在现有 applyCrop() 旁新增 applyCropLocal(id, crop) 函数
- 逻辑与 applyCrop() 相同但**跳过 autoLayout() 调用**
- 流程：记录快照 → 恢复原始 crop/layoutCrop → 设置新 crop → 更新显示尺寸 → pushHistory()

#### 1b. CanvasStage.vue 调用替换（CanvasStage.vue:946-953）
- 将 `store.applyCrop(photo.id, {...})` 改为 `store.applyCropLocal(photo.id, {...})`
- 随后的 `store.commitCropMode()` 保持不变

#### 1c. 裁剪模式 z-index 处理（mosaic.ts:291-297）
修改 sortedPhotos computed：当 cropModePhotoId 不为 null 时，将裁剪中的照片排到最前面（z-index 最低），使其他照片覆盖其上方，形成"固定裁剪框"效果。

---

### Step 2: P0-2 — 150 张布局验证与加固

#### 2a. 验证现有实现（手动测试）
- 导入 150 张照片 → 检查 Console `[LayoutDebug]` 输出：`Created >= 150 tiles, needed 150`
- 导入 160 张照片 → 验证 toast 提示正确显示

#### 2b. 布局算法微调（useLayout.ts:292）
当前 minSide 公式适配 150 张照片。若验证不通过：
- 将衰减系数从 0.75 调整为 0.65，或
- 将放松轮次从 6 增加到 8（在 useLayout.ts:355-365 范围内修改）

#### 2c. 同步修改 layoutWorker（layoutWorker.ts:39-198）
填充 fillArrangePhotosWorker() 成为 fillArrangePhotos() 的镜像副本，任何修改需同步。

---

### Step 3: P1-3 — 人脸红框（已完成，仅验证）
- SidebarRight.vue:99-108：SVG `<rect>` 已绘制 `stroke="#ff0000"` 红框
- SidebarRight.vue:392-405：faceBoxes computed 已过滤 `kind==='face'`
- SidebarRight.vue:389：detectionTick 确保响应式更新
- **无需代码变更**，仅验证运行时正确性

---

### Step 4: 优化 1 — 智能裁剪比例限制

#### 4a. 添加比例约束（smartCrop.ts:723-830）
在 `maxFit = fitAspectInside(base, targetAspect)` 之后插入：
- **竖图**（imageHeight > imageWidth）：targetAspect ≤ 1.5（6:4）
- **横图**（imageWidth > imageHeight）：targetAspect ≥ 0.667（4:6）
- 超出限制时，clamp 后重新计算 maxFit

#### 4b. 人脸最小尺寸保证（smartCrop.ts:752-802）
在返回最终裁剪框之前：
- 检查每个人脸的可见尺寸：`visibleW = Math.min(face.x + face.width, crop.x + crop.width) - Math.max(face.x, crop.x)`
- 若任何人脸可见尺寸 < 100×100 px，扩大裁剪框直到满足条件
- 人脸完整性优先于比例限制

---

### Step 5: 优化 2 — 中心放置比例接近 1:1 的照片

#### 5a. 修改贪心匹配策略（useLayout.ts:401-437）
- **预计算**：
    - 每张照片的宽高比偏离度：`deviation = Math.abs(Math.log(photoAspect))`（0 = 正方）
    - 每个 tile 的中心距离：`dist = Math.sqrt((tileCx - canvasW/2)² + (tileCy - canvasH/2)²)`，归一化到 [0, 1]

- **修改遍历顺序**：从中心到边缘排序（dist 升序），而非按面积降序

- **修改评分函数**：
    ```
    score = aspectMatchScore - alpha × dist
    ```
    其中 alpha ≈ 0.3，使中心 tile 更偏向选择接近 1:1 的照片

#### 5b. 同步修改 layoutWorker（layoutWorker.ts:39-198）
Mirror Step 5a 的所有修改。

---

## 验证清单

| 项目 | 验证步骤 |
|------|---------|
| **P0-1** | 选中照片 → 裁剪 → 拖动内容 → 确认 → 验证其他照片位置不变，无 autoLayout 调用 |
| **P0-2** | 导入 150 张 → Console 查看 `[LayoutDebug]` ✓；导入 160 张 → 验证 toast 提示 ✓ |
| **P1-3** | 选中含人脸照片 → 右侧"原图缩略"区域显示红框 ✓ |
| **优化1** | 竖图 layoutCrop 宽高比 ≤ 1.5 ✓；含人脸竖图人脸 ≥ 100×100 px ✓ |
| **优化2** | 混合比例照片 → 中心区域更多接近正方形照片 ✓ |

---

## 关键决策

1. **P0-1**：新增 applyCropLocal() 而非修改 applyCrop()，保持现有调用场景不变
2. **P1-3**：无需修改，仅验证运行时正确性
3. **优化2**：采用 tile 中心距离排序 + 混合评分，alpha 参数可后续调优
4. **Worker 同步**：useLayout.ts 和 layoutWorker.ts 需保持逻辑镜像一致