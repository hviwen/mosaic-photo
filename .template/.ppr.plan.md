
## 0. 目标

### 目标
- 每张图在各自 tile 内自动缩放裁剪，尽量不裁掉人脸/动物脸/主体

## 1. 技术选型与架构

### 1.1 模型/推理
**MediaPipe Tasks Vision**
- `FaceDetector`：人脸框（快、足够做 face-safe）
- `ObjectDetector`：动物/人/主体框兜底

**推理运行在 Web Worker**（强烈建议）
- 主线程：Canvas/WebGL 渲染、交互
- Worker：解码、缩略图生成、检测、返回 keep-regions
- 导入 50-100 张也不至于卡 UI

### 1.2 渲染
中间画布区建议用：
- 2D Canvas（足够）或
- WebGL（图片多、缩放频繁时更稳）

每张图在 tile 内的渲染参数统一用 `cropTransform` 表示

### 1.3 状态管理
Pinia 管理全局：项目、布局、素材、检测结果、选中图层、导出配置

---

## 2. 数据结构

```typescript
// 原图信息
type Asset = {
    id: string
    fileName: string
    width: number
    height: number
    exifOrientation?: number
    bitmap: ImageBitmap
    thumb?: ImageBitmap
}

// 检测出的"需要保留区域"
type KeepRegion = {
    kind: 'face' | 'object'
    label?: string
    score: number
    box: { x: number; y: number; w: number; h: number }
}

// 检测结果
type VisionMeta = {
    faces: KeepRegion[]
    objects: KeepRegion[]
}

// Tile 布局结果
type Tile = {
    id: string
    assetId: string
    x: number; y: number; w: number; h: number; z: number
}

// 裁剪参数
type CropTransform = {
    cropX: number
    cropY: number
    cropW: number
    cropH: number
    locked?: boolean
}

// 图层/照片实例
type Layer = {
    id: string
    assetId: string
    tileId: string
    vision?: VisionMeta
    crop: CropTransform
    adjustments?: { exposure?: number; contrast?: number; saturation?: number }
    mask?: any
}
```

---

## 3. 关键模块拆分

| 模块 | 职责 |
|------|------|
| **vision-worker** | 初始化检测器、运行推理、返回 VisionMeta |
| **layout-engine** | 生成错落 tile 网格、无间隙铺满 |
| **crop-engine** | 实现 face-safe crop 算法 |
| **renderer** | Canvas 显示 & 高分辨率导出 |

---

## 4. Face-Safe Crop 算法

### 4.1 计算权重
- Faces：`weight = 10 × score × √(boxArea / imageArea)`
- Objects：`weight = 3 × score × √(boxArea / imageArea)`
- 每个 box 外扩 margin（m = 0.12）作为安全框

### 4.2 裁剪窗口尺寸
比例 R = TW / TH，若 IW/IH > R：
```
cropH = IH
cropW = IH × R
```
否则：`cropW = IW`，`cropH = IW / R`

### 4.3 确定位置
加权重心：`cx = Σ(w_i × centerX_i) / Σ(w_i)`，`cy = Σ(w_i × centerY_i) / Σ(w_i)`

clamped 到有效范围：`[0, IW-cropW] × [0, IH-cropH]`

### 4.4 评分微调（推荐）
在 `dx,dy ∈ [-S, S]` 范围内采样（S ≤ 80px），用以下评分函数：
```
score = Σ(w_i × coverage_i) - λ × borderPenalty
```
选最高分的窗口

### 4.5 用户锁定策略
- 用户调整 crop 时设置 `crop.locked = true`
- 后续保持或提示重算

---

## 5. 工作流

### 5.1 导入 → 5.2 排版 → 5.3 裁剪 → 5.4 微调

**关键点**
- 生成缩略图（短边 512）用于检测
- 并发队列限制 2~4 张
- 检测结果到达后若未锁定则更新 crop

---